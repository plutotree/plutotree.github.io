<rss xmlns:atom="http://www.w3.org/2005/Atom" version="2.0"><channel><title>Jekyll - 标签 - PlutoTree's Blog</title><link>https://plutotree.me/tags/jekyll/</link><description>Jekyll - 标签 - PlutoTree's Blog</description><generator>Hugo -- gohugo.io</generator><language>zh-CN</language><managingEditor>plutotreetree@gmail.com (布鲁树)</managingEditor><webMaster>plutotreetree@gmail.com (布鲁树)</webMaster><lastBuildDate>Thu, 10 Apr 2025 01:00:00 +0800</lastBuildDate><atom:link href="https://plutotree.me/tags/jekyll/" rel="self" type="application/rss+xml"/><item><title>博客从 Jekyll 迁移到 Hugo：Valine评论系统相关问题</title><link>https://plutotree.me/2025/04/migrate-from-jekyll-to-hugo/</link><pubDate>Thu, 10 Apr 2025 01:00:00 +0800</pubDate><author>布鲁树</author><guid>https://plutotree.me/2025/04/migrate-from-jekyll-to-hugo/</guid><description><![CDATA[<div class="featured-image">
                <img src="https://pic-1251468582.file.myqcloud.com/pic/2025/04/10/VZLUG8.jpg" referrerpolicy="no-referrer">
            </div><p>最近将博客从 Jekyll 迁移到 Hugo 了，虽然 Valine 评论系统在 Hugo 中可以直接通过配置文件 <code>hugo.toml</code> 进行设置，但在实际使用中发现了一些坑，以下是整理的解决方案。</p>
<h2 id="1-配置-requiredfields-无效问题">1. 配置 <code>requiredFields</code> 无效问题</h2>
<p>在 Valine 的官方文档中提到，可以通过 <code>requiredFields</code> 配置字段来设置评论时的必填项，比如昵称、邮箱等。然而，在 Hugo 中直接配置后发现该功能无效。</p>
<h3 id="问题原因">问题原因</h3>
<p>Hugo 主题下文件 <code>layouts/partials/comment.html</code> 文件中只针对部分字段进行了处理，而没有对 <code>requiredFields</code> 进行正确处理。</p>
<h3 id="解决方法">解决方法</h3>
<p>将 <code>comment.html</code> 文件复制到项目中相同目录下，然后增加以下代码：</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-html">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="复制到剪贴板"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl">{{- with $valine.requiredFields -}} {{- $commentConfig = dict &#34;requiredFields&#34; .
</span></span><span class="line"><span class="cl">| dict &#34;valine&#34; | merge $commentConfig -}} {{- end -}}</span></span></code></pre></div></div>
<h2 id="2-gravatar-头像显示问题">2. Gravatar 头像显示问题</h2>
<p>在配置头像时发现，随机头像无法正常显示，例如以下头像地址。但是将域名替换为 <a href="https://www.gravatar.com/avatar/d41d8cd98f00b204e9800998ecf8427e?d=wavatar&amp;v=1.5.2" target="_blank" rel="noopener noreffer ">www.gravatar.com</a> 则可以正常显示。<br>
<a href="https://gravatar.loli.net/avatar/d41d8cd98f00b204e9800998ecf8427e?d=wavatar&amp;v=1.5.2" target="_blank" rel="noopener noreffer ">https://gravatar.loli.net/avatar/d41d8cd98f00b204e9800998ecf8427e?d=wavatar&v=1.5.2</a></p>
<h3 id="问题原因-1">问题原因</h3>
<p>Gravatar 的中转服务，gravatar.loli.net 存在处理上的问题，导致随机头像无法显示。</p>
<h3 id="解决方法-1">解决方法</h3>
<p>由于 Gravatar 的官网在国内访问存在较多问题，更换了另一个 Gravatar 的中转服务： cn.gravatar.com。在配置文件中增加 avatar_cdn 之后，发现这个配置不生效。需要增加类似的处理逻辑，修改 <code>comment.html</code> 文件：</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-html">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="复制到剪贴板"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl">{{- with $valine.avatar_cdn -}} {{- $commentConfig = dict &#34;avatar_cdn&#34; . | dict
</span></span><span class="line"><span class="cl">&#34;valine&#34; | merge $commentConfig -}} {{- end -}}</span></span></code></pre></div></div>
<p>修改后，Gravatar 头像和随机头像的显示恢复正常，但邮箱为空时随机头像无法随机。</p>
<h2 id="邮箱为空时头像并不会随机">邮箱为空时头像并不会随机</h2>
<h3 id="问题原因-2">问题原因</h3>
<p>获取随机头像的 MD5 是根据邮箱地址进行生成，而邮箱地址为空时其生成的 MD5 是固定的，这也导致获取的也都是固定头像。</p>
<h3 id="解决方法-2">解决方法</h3>
<p>将 <code>valine.min.js</code> 中的 <code>t.get(&quot;mail&quot;)</code> 修改为 <code>t.get(&quot;mail&quot;) || t.get(&quot;nick&quot;)</code>，即邮箱为空时使用昵称计算随机头像。修改后需要将文件发布到 CDN 才能使用，具体步骤不在此赘述。</p>
<h2 id="qq-头像和昵称获取问题">QQ 头像和昵称获取问题</h2>
<p>在 Valine 中，昵称字段输入 QQ 时，预期是可以获取 QQ 头像和昵称的，但是实际测试的时候却无法正确获取。在 Chrome 的调试窗口，可以看到访问第三方的 API 地址的时候会报错：</p>
<p><a href="https://api.qjqq.cn/api/qqinfo?qq=12345" target="_blank" rel="noopener noreffer ">https://api.qjqq.cn/api/qqinfo?qq=12345</a></p>
<h3 id="问题原因-3">问题原因</h3>
<p>就在写该文章的几天前直接在浏览器中访问这个地址还是正常的，不过会因为跨域问题而导致在 Valine 中无法正常使用。今天访问这个地址，发现这个服务已经无法访问了，页面会跳转到一个 API 服务平台<a href="https://api.nsmao.net/" target="_blank" rel="noopener noreffer ">奶思猫</a>。</p>
<h3 id="解决方法-3">解决方法</h3>
<p>在网站上搜索后，发现有免费的<a href="https://api.nsmao.net/api/qq/query" target="_blank" rel="noopener noreffer ">QQ 信息服务接口</a>。这个 API 的回包结构和 Valine 中使用的 api.qjqq.cn 是不一致的。由于原来的接口已经下线，正确的回包结构目前也不清楚。好在现在有强大的 AI，直接把压缩的 JS 代码丢给 AI，它就能分析出原来处理 QQ 头像和昵称的逻辑。</p>
<div class="code-block code-line-numbers" style="counter-reset: code-block 0">
    <div class="code-header language-javascript">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="复制到剪贴板"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">i</span><span class="p">.</span><span class="k">default</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">QQCacheKey</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nx">n</span> <span class="o">&amp;&amp;</span> <span class="nx">n</span><span class="p">.</span><span class="nx">qq</span> <span class="o">==</span> <span class="nx">e</span>
</span></span><span class="line"><span class="cl">    <span class="o">?</span> <span class="nx">t</span> <span class="o">&amp;&amp;</span> <span class="nx">t</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">:</span> <span class="nx">i</span><span class="p">.</span><span class="k">default</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">          <span class="nx">url</span><span class="o">:</span> <span class="s2">&#34;https://api.nsmao.net/api/qq/query?key=xx&amp;qq=&#34;</span> <span class="o">+</span> <span class="nx">e</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nx">method</span><span class="o">:</span> <span class="s2">&#34;get&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">})</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="k">return</span> <span class="nx">e</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">})</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="k">if</span> <span class="p">(</span><span class="mi">200</span> <span class="o">==</span> <span class="nx">n</span><span class="p">.</span><span class="nx">code</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">nick</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nx">a</span> <span class="o">=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">avatar</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nx">u</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">nick</span><span class="o">:</span> <span class="nx">r</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nx">qq</span><span class="o">:</span> <span class="nx">e</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nx">pic</span><span class="o">:</span> <span class="nx">a</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="p">};</span>
</span></span><span class="line"><span class="cl">            <span class="nx">i</span><span class="p">.</span><span class="k">default</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">QQCacheKey</span><span class="p">,</span> <span class="nx">u</span><span class="p">),</span> <span class="nx">t</span> <span class="o">&amp;&amp;</span> <span class="nx">t</span><span class="p">(</span><span class="nx">u</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span></span></span></code></pre></div></div>
<p>我们有两种方案分别是在客户端直接修改和在服务端进行中转：</p>
<p>方案 1：修改 Valine 中请求的 url 以及回包解析逻辑。方案修改起来很容易，最大的问题是会暴露了密钥。</p>
<ul>
<li>修改请求 URL：<code>api.njqq.cn/api/qqinfo?qq=xxx</code> 修改成 <code>https://api.nsmao.net/api/qq/query?key=xx&amp;qq=</code></li>
<li>修改昵称和头像的获取：<code>{var r=n.name,a=n.imgurl</code> 修改成 <code>{var r=n.data.nick,a=n.data.avatar</code>。</li>
</ul>
<p>方案 2：后台提供中转服务</p>
<p>通过自己的服务器封装中转接口，避免密钥暴露，接口可以丢给 AI 实现，但需要额外的服务维护成本。</p>
<p>下面是用 golang 实现的获取QQ资料的 HTTP 服务，功能就是将奶思猫提供的 QQ 资料的API接口转换成适配Valine的格式。需要设置下密钥和访问端口。</p>
<div class="code-block code-line-numbers" style="counter-reset: code-block 0">
    <div class="code-header language-golang">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="复制到剪贴板"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;encoding/json&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;io/ioutil&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;log&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;net/http&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;os&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// APIResponse represents the response from the QQ API</span>
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">APIResponse</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Code</span>     <span class="kt">int</span>    <span class="s">`json:&#34;code&#34;`</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Msg</span>      <span class="kt">string</span> <span class="s">`json:&#34;msg&#34;`</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Data</span>     <span class="nx">QQData</span> <span class="s">`json:&#34;data&#34;`</span>
</span></span><span class="line"><span class="cl">        <span class="nx">ExecTime</span> <span class="kt">float64</span> <span class="s">`json:&#34;exec_time&#34;`</span>
</span></span><span class="line"><span class="cl">        <span class="nx">IP</span>       <span class="kt">string</span>  <span class="s">`json:&#34;ip&#34;`</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// QQData represents the data field in the API response</span>
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">QQData</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Nick</span>      <span class="kt">string</span> <span class="s">`json:&#34;nick&#34;`</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Qid</span>       <span class="kt">string</span> <span class="s">`json:&#34;qid&#34;`</span>
</span></span><span class="line"><span class="cl">        <span class="nx">RegTime</span>   <span class="kt">string</span> <span class="s">`json:&#34;regTime&#34;`</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Level</span>     <span class="kt">int</span>    <span class="s">`json:&#34;level&#34;`</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Avatar</span>    <span class="kt">string</span> <span class="s">`json:&#34;avatar&#34;`</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Email</span>     <span class="kt">string</span> <span class="s">`json:&#34;email&#34;`</span>
</span></span><span class="line"><span class="cl">        <span class="nx">IsVip</span>     <span class="kt">bool</span>   <span class="s">`json:&#34;is_vip&#34;`</span>
</span></span><span class="line"><span class="cl">        <span class="nx">IsYearsVip</span> <span class="kt">bool</span>  <span class="s">`json:&#34;is_years_vip&#34;`</span>
</span></span><span class="line"><span class="cl">        <span class="nx">VipLevel</span>  <span class="kt">int</span>    <span class="s">`json:&#34;vip_level&#34;`</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// ClientResponse represents the response we&#39;ll send to the client</span>
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">ClientResponse</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Code</span>   <span class="kt">int</span>    <span class="s">`json:&#34;code&#34;`</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Name</span>   <span class="kt">string</span> <span class="s">`json:&#34;name&#34;`</span>
</span></span><span class="line"><span class="cl">        <span class="nx">ImgURL</span> <span class="kt">string</span> <span class="s">`json:&#34;imgurl&#34;`</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Email</span>  <span class="kt">string</span> <span class="s">`json:&#34;email&#34;`</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Get the API key from environment variable or use default</span>
</span></span><span class="line"><span class="cl">        <span class="nx">apiKey</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;QQ_API_KEY&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">apiKey</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">apiKey</span> <span class="p">=</span> <span class="s">&#34;MY_KEY&#34;</span> <span class="c1">// Default key for development</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">http</span><span class="p">.</span><span class="nf">HandleFunc</span><span class="p">(</span><span class="s">&#34;/qq_api/qqinfo&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// Get QQ number from query parameter</span>
</span></span><span class="line"><span class="cl">                <span class="nx">qqNumber</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nf">Query</span><span class="p">().</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;qq&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="nx">qqNumber</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nx">http</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="s">&#34;Missing qq parameter&#34;</span><span class="p">,</span> <span class="nx">http</span><span class="p">.</span><span class="nx">StatusBadRequest</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="k">return</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="c1">// Construct the API URL</span>
</span></span><span class="line"><span class="cl">                <span class="nx">apiURL</span> <span class="o">:=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;https://api.nsmao.net/api/qq/query?key=%s&amp;qq=%s&#34;</span><span class="p">,</span> <span class="nx">apiKey</span><span class="p">,</span> <span class="nx">qqNumber</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="c1">// Make the request to the QQ API</span>
</span></span><span class="line"><span class="cl">                <span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">apiURL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Error making request to QQ API: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="nx">http</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="s">&#34;Failed to fetch QQ information&#34;</span><span class="p">,</span> <span class="nx">http</span><span class="p">.</span><span class="nx">StatusInternalServerError</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="k">return</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">defer</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">Body</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="c1">// Read the response body</span>
</span></span><span class="line"><span class="cl">                <span class="nx">body</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ioutil</span><span class="p">.</span><span class="nf">ReadAll</span><span class="p">(</span><span class="nx">resp</span><span class="p">.</span><span class="nx">Body</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Error reading response body: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="nx">http</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="s">&#34;Failed to read QQ information&#34;</span><span class="p">,</span> <span class="nx">http</span><span class="p">.</span><span class="nx">StatusInternalServerError</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="k">return</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="c1">// Parse the API response</span>
</span></span><span class="line"><span class="cl">                <span class="kd">var</span> <span class="nx">apiResp</span> <span class="nx">APIResponse</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">(</span><span class="nx">body</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">apiResp</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Error parsing API response: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="nx">http</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="s">&#34;Failed to parse QQ information&#34;</span><span class="p">,</span> <span class="nx">http</span><span class="p">.</span><span class="nx">StatusInternalServerError</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="k">return</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="c1">// Prepare the client response</span>
</span></span><span class="line"><span class="cl">                <span class="nx">clientResp</span> <span class="o">:=</span> <span class="nx">ClientResponse</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nx">Code</span><span class="p">:</span>   <span class="mi">200</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="nx">Name</span><span class="p">:</span>   <span class="s">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="nx">ImgURL</span><span class="p">:</span> <span class="s">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="nx">Email</span><span class="p">:</span>  <span class="s">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="c1">// Only populate the fields if the API request was successful</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="nx">apiResp</span><span class="p">.</span><span class="nx">Code</span> <span class="o">==</span> <span class="mi">200</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nx">clientResp</span><span class="p">.</span><span class="nx">Name</span> <span class="p">=</span> <span class="nx">apiResp</span><span class="p">.</span><span class="nx">Data</span><span class="p">.</span><span class="nx">Nick</span>
</span></span><span class="line"><span class="cl">                        <span class="nx">clientResp</span><span class="p">.</span><span class="nx">ImgURL</span> <span class="p">=</span> <span class="nx">apiResp</span><span class="p">.</span><span class="nx">Data</span><span class="p">.</span><span class="nx">Avatar</span>
</span></span><span class="line"><span class="cl">                        <span class="nx">clientResp</span><span class="p">.</span><span class="nx">Email</span> <span class="p">=</span> <span class="nx">apiResp</span><span class="p">.</span><span class="nx">Data</span><span class="p">.</span><span class="nx">Email</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="c1">// If the API request failed, pass along the error code</span>
</span></span><span class="line"><span class="cl">                        <span class="nx">clientResp</span><span class="p">.</span><span class="nx">Code</span> <span class="p">=</span> <span class="nx">apiResp</span><span class="p">.</span><span class="nx">Code</span>
</span></span><span class="line"><span class="cl">                        <span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;API returned error: %s&#34;</span><span class="p">,</span> <span class="nx">apiResp</span><span class="p">.</span><span class="nx">Msg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="c1">// Set content type header</span>
</span></span><span class="line"><span class="cl">                <span class="nx">w</span><span class="p">.</span><span class="nf">Header</span><span class="p">().</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;Content-Type&#34;</span><span class="p">,</span> <span class="s">&#34;application/json&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="c1">// Encode and send the response</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">NewEncoder</span><span class="p">(</span><span class="nx">w</span><span class="p">).</span><span class="nf">Encode</span><span class="p">(</span><span class="nx">clientResp</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Error encoding client response: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="nx">http</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="s">&#34;Failed to encode response&#34;</span><span class="p">,</span> <span class="nx">http</span><span class="p">.</span><span class="nx">StatusInternalServerError</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="k">return</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Start the HTTP server</span>
</span></span><span class="line"><span class="cl">        <span class="nx">port</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;PORT&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">port</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">port</span> <span class="p">=</span> <span class="s">&#34;52101&#34;</span> <span class="c1">// Default port</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Starting server on port %s&#34;</span><span class="p">,</span> <span class="nx">port</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nf">ListenAndServe</span><span class="p">(</span><span class="s">&#34;:&#34;</span><span class="o">+</span><span class="nx">port</span><span class="p">,</span> <span class="kc">nil</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">log</span><span class="p">.</span><span class="nf">Fatalf</span><span class="p">(</span><span class="s">&#34;Failed to start server: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div></div>
<p>另外还需要在 nginx 配置中进行 proxy_pass 的转发配置，这里不再赘述i。</p>
<h2 id="评论数据迁移">评论数据迁移</h2>
<p>如果 URL 没有改变，评论数据是无需处理的。如果 URL 发生了变化，并且你想保留之前的评论数据，那就需要手动进行迁移。 Valine 的所有数据是存储在 LeanCloud 中，可以很方便地通过脚本进行修改。</p>
<p>不过因为我的评论量少得可怜，我就直接手动修改了。</p>
<h2 id="总结">总结</h2>
<p>Valine 评论系统现在已经基于处理停止维护的状态了，而且新的版本源友也没有完全开源的服务，存在较大的局限性。未来如果有时间的话，升级 Waline 似乎是一个比较好的选择。Waline 不仅功能更完善，还提供了更好的国内访问体验和开源支持。另外最大的差异其实是 Waline 是需要后台服务，这一点可以说是优点，也可以说是限制。</p>
]]></description></item><item><title>在jekyll中使用valine评论系统</title><link>https://plutotree.me/2021/09/add-valine-comment-system-in-jekyll/</link><pubDate>Mon, 06 Sep 2021 17:30:00 +0800</pubDate><author>布鲁树</author><guid>https://plutotree.me/2021/09/add-valine-comment-system-in-jekyll/</guid><description><![CDATA[<blockquote>
<p>最近发现无法展示评论，提示找不到 AV 相关的定义，移除了<code>av-min.js</code>，以及<code>AV</code>的字段定义，似乎是新版本改了实现，会在内部引用<code>av-min.js</code>。</p></blockquote>
<p>博客怎么能少了评论系统，但是一直没有找到满意的，各种国内被禁的，缺乏更新维护的，做得太复杂的等等之类的。今天看到一个感觉还不错的评论系统<a href="https://valine.js.org/" target="_blank" rel="noopener noreffer ">Valine</a>，一款快速、简洁且高效的无后端评论系统，存储基于 leancloud。作者的<a href="https://github.com/staticblog/staticblog.github.io" target="_blank" rel="noopener noreffer ">博客</a>提供了一个 jekyll 的示例，直接引入。</p>
<p>先参考<a href="https://valine.js.org/quickstart.html#%E8%8E%B7%E5%8F%96APP-ID-%E5%92%8C-APP-Key" target="_blank" rel="noopener noreffer ">这里</a>的说明，注册 Leancloud 并创建新的应用，顺便提一下，现在监管严格，需要进行实名注册，最后还要支付宝扫描验证。</p>
<p>接着直接修改 jekyll 的内容即可（下面的内容照抄作者博客，也可以按自己习惯定义变量）</p>
<ol>
<li>
<p>修改<code>default.html</code>，在 footer.html 前面增加下面这段内容</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-html">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="复制到剪贴板"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl">{% if site.data.social.valine_comment.enable and page.comments == true %}
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;comments&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">{% endif %} {% include scripts.html %}</span></span></code></pre></div></div>
</li>
<li>
<p>修改<code>_includes/head.html</code>，在合适的地方增加下面这段内容</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-html">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="复制到剪贴板"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="c">&lt;!-- Valine Comment --&gt;</span>
</span></span><span class="line"><span class="cl">{% if site.data.social.valine_comment.enable and page.comments == true %}
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&#34;//unpkg.com/valine/dist/Valine.min.js&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">{% endif %}</span></span></code></pre></div></div>
</li>
<li>
<p>在<code>_includes</code>下面增加新文件<code>valine_comments.html</code></p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-html">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="复制到剪贴板"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="k">new</span> <span class="nx">Valine</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">    <span class="nx">el</span><span class="o">:</span> <span class="s2">&#34;#comments&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">app_id</span><span class="o">:</span> <span class="s2">&#34;你的Leacloud Appid&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">app_key</span><span class="o">:</span> <span class="s2">&#34;你的Leancloud Appkey&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">placeholder</span><span class="o">:</span> <span class="s2">&#34;{{ site.data.social.valine_comment.placeholder }}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span></span></span></code></pre></div></div>
</li>
<li>
<p>在<code>_includes</code>下面增加新文件<code>scripts.html</code>（需要手动在<code>{</code>后面及<code>}</code>前面增加<code>%</code>）</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-html">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="复制到剪贴板"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl">{ if page.comments }{ include valine_comments.html }{ endif }</span></span></code></pre></div></div>
</li>
<li>
<p>在<code>_data</code>下面增加新文件<code>social.yml</code></p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-yaml">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="复制到剪贴板"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">valine_comment</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">enable</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">leancloud_appid</span><span class="p">:</span><span class="w"> </span><span class="l">你的Leancloud Appid</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">leancloud_appkey</span><span class="p">:</span><span class="w"> </span><span class="l">你的Leancloud appkey</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">placeholder</span><span class="p">:</span><span class="w"> </span><span class="l">just go go</span></span></span></code></pre></div></div>
</li>
<li>
<p>在你的文章头增加<code>comments: true</code></p>
</li>
</ol>
<p>另外还看到一个基于 valine 的评论系统，叫做<a href="https://github.com/walinejs/waline" target="_blank" rel="noopener noreffer ">waline</a>，功能很齐全，有空可以再研究下。</p>
]]></description></item><item><title>在github pages上使用jekyll</title><link>https://plutotree.me/2021/09/create-github-blog-using-jekyll/</link><pubDate>Mon, 06 Sep 2021 15:30:00 +0800</pubDate><author>布鲁树</author><guid>https://plutotree.me/2021/09/create-github-blog-using-jekyll/</guid><description><![CDATA[<p>网上有大量文章说明如何在 github pages 上面使用 jekyll，这里仅说明下大致流程</p>
<ul>
<li>导出 git</li>
<li>本地编辑 markdown</li>
<li>本地启动 jekyll，验证文章效果</li>
<li>git 提交</li>
<li>网页生效</li>
</ul>
<ol>
<li>
<p>选择合适的 jekyll 模版，也可以直接使用我的网站（记得删除_posts 和 raw 目录）</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-bash">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="复制到剪贴板"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">git clone <span class="s2">&#34;https://github.com/plutotree/plutotree.github.io.git&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> plutotree.github.io.git</span></span></code></pre></div></div>
</li>
<li>
<p>安装必要的依赖，以及启动 jekyll</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-bash">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="复制到剪贴板"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 安装ruby，不使用自带的版本</span>
</span></span><span class="line"><span class="cl">brew install ruby@2.7
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span><span class="s2">&#34;/opt/homebrew/opt/ruby@2.7/bin:</span><span class="nv">$PATH</span><span class="s2">&#34;</span> &gt;&gt; ~/.zshrc
</span></span><span class="line"><span class="cl"><span class="nb">source</span> ~/.zshrc
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 适用bundler做gem包管理</span>
</span></span><span class="line"><span class="cl">gem install bundler
</span></span><span class="line"><span class="cl">bundle install
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 启动jekyll</span>
</span></span><span class="line"><span class="cl">bundle <span class="nb">exec</span> jekyll serve</span></span></code></pre></div></div>
</li>
</ol>
<ul>
<li>
<p>为什么使用 ruby 2.7</p>
<p>参考<a href="https://pages.github.com/versions/" target="_blank" rel="noopener noreffer ">GitHub Pages 依赖的版本信息</a>，ruby 支持的版本为 2.7.3</p>
</li>
</ul>
]]></description></item><item><title>在jekyll中使用百度统计</title><link>https://plutotree.me/2019/02/using-baidu-analytics-in-jekyll/</link><pubDate>Fri, 01 Feb 2019 15:30:00 +0800</pubDate><author>布鲁树</author><guid>https://plutotree.me/2019/02/using-baidu-analytics-in-jekyll/</guid><description><![CDATA[<blockquote>
<p>腾讯统计已下线，可以查看最后一部分引入百度统计</p></blockquote>
<h2 id="操作步骤">操作步骤</h2>
<p>加入腾讯统计的方法非常简单，只需要 2 步就可以了：</p>
<ol>
<li>
<p>在<a href="https://ta.qq.com/" target="_blank" rel="noopener noreffer ">腾讯分析</a>申请创建一个项目，得到一段类似代码：</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-javascript">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="复制到剪贴板"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="o">&lt;</span><span class="nx">script</span>
</span></span><span class="line"><span class="cl">  <span class="nx">type</span><span class="o">=</span><span class="s2">&#34;text/javascript&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">src</span><span class="o">=</span><span class="s2">&#34;http://tajs.qq.com/stats?sId=66171907&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">charset</span><span class="o">=</span><span class="s2">&#34;UTF-8&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&lt;</span><span class="err">/script&gt;</span></span></span></code></pre></div></div>
</li>
<li>
<p>在<code>_includes/footer.html</code>（如果该文件不存在的话，可以从模板里面拷贝出来）最后增加一行，将上面的代码拷贝进去，这时候正常运行就可以得到统计结果了；</p>
</li>
</ol>
<p><a href="https://tongji.baidu.com" target="_blank" rel="noopener noreffer ">百度统计</a>的方式也类似，如果想要在 header 引入的话可以考虑放在<code>_includes/head.html</code>。</p>
<p>这时候本地调试也会上报统计，这种情况如果不想上报的话，需要加上判断条件。这里用了<code>jekyll.enviroment</code>变量，该变量在 github pages 发布的时候会设置成<code>production</code>，而本地没有设置该变量就不会引入该 script。注意下代码的<code>%</code>需要加上对应的<code>{</code>和<code>}</code>（没有直接加是因为会被 jekyll 自动处理）</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-javascript">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="复制到剪贴板"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="o">%-</span> <span class="k">if</span> <span class="nx">jekyll</span><span class="p">.</span><span class="nx">environment</span> <span class="o">==</span> <span class="s1">&#39;production&#39;</span> <span class="o">-%</span>
</span></span><span class="line"><span class="cl">  <span class="o">&lt;</span><span class="nx">script</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&#34;text/javascript&#34;</span> <span class="nx">src</span><span class="o">=</span><span class="s2">&#34;http://tajs.qq.com/stats?sId=66171907&#34;</span> <span class="nx">charset</span><span class="o">=</span><span class="s2">&#34;UTF-8&#34;</span><span class="o">&gt;&lt;</span><span class="err">/script&gt;</span>
</span></span><span class="line"><span class="cl"><span class="o">%-</span> <span class="nx">endif</span> <span class="o">-%</span></span></span></code></pre></div></div>
<p>如果你调试的时候想临时验证下的话，可以指定环境变量，类似这样子执行：</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-bash">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="复制到剪贴板"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">JEKYLL_ENV</span><span class="o">=</span>production bundle <span class="nb">exec</span> jekyll serve</span></span></code></pre></div></div>
<p>再进一步，也可以在配置文件里面增加配置项用来配置是否启用腾讯统计或者百度统计。在<code>_config.yml</code>增加一行<code>tencent_analytics: 1</code>，然后在<code>_includes/footer.html</code>里面的条件换成</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-javascript">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="复制到剪贴板"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="o">%-</span> <span class="k">if</span> <span class="nx">jekyll</span><span class="p">.</span><span class="nx">environment</span> <span class="o">==</span> <span class="s1">&#39;production&#39;</span> <span class="nx">and</span> <span class="nx">site</span><span class="p">.</span><span class="nx">tencent_analytics</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">-%</span></span></span></code></pre></div></div>
<h2 id="更新">更新</h2>
<p>腾讯分析将于 2020 年 12 月 31 日下线，这里引导的腾讯移动分析也将在 2021 年 3 月份下线，所以只能放弃腾讯分析了。</p>
<p></p>
<p>只能切到<a href="https://tongji.baidu.com/sc-web" target="_blank" rel="noopener noreffer ">百度统计</a>了，百度统计的 js 看着有点复杂，先直接拷贝吧。</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-javascript">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="复制到剪贴板"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="o">&lt;</span><span class="nx">script</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">_hmt</span> <span class="o">=</span> <span class="nx">_hmt</span> <span class="o">||</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">var</span> <span class="nx">hm</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;script&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nx">hm</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="s2">&#34;https://hm.baidu.com/hm.js?xxxxxx&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kd">var</span> <span class="nx">s</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s2">&#34;script&#34;</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="nx">s</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">insertBefore</span><span class="p">(</span><span class="nx">hm</span><span class="p">,</span> <span class="nx">s</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">})();</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="err">/script&gt;</span></span></span></code></pre></div></div>
]]></description></item><item><title>jekyll自动生成目录的几种方案</title><link>https://plutotree.me/2019/01/jekyll-toc-solution/</link><pubDate>Wed, 30 Jan 2019 13:00:00 +0800</pubDate><author>布鲁树</author><guid>https://plutotree.me/2019/01/jekyll-toc-solution/</guid><description><![CDATA[<p>jekyll 的<code>kramdown</code>不支持<code>[TOC]</code>自动生成目录的方式，目前了解来看有几种方案：</p>
<ol>
<li>
<p>在正文中添加如下标签，这个方案优点在于不需要额外配置，github pages 也默认支持，缺点在于格式看着不太优雅，不符合<a href="https://github.com/DavidAnson/markdownlint" target="_blank" rel="noopener noreffer ">markdownlint</a>规范，在<code>visual studio code</code>的 markdownlint 插件下会导致一堆 lint 告警；</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-markdown">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="复制到剪贴板"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-markdown" data-lang="markdown"><span class="line"><span class="cl"><span class="k">-</span> TOC
</span></span><span class="line"><span class="cl">  {:toc}</span></span></code></pre></div></div>
</li>
<li>
<p>使用<a href="https://github.com/toshimaru/jekyll-toc" target="_blank" rel="noopener noreffer "><code>jekyll-toc</code>插件</a>，这种方式实现比较优雅，也不会破坏 markdown 源文件，缺点在于 github pages 并不支持自定义插件；</p>
<ul>
<li>
<p>在网站的<code>gemfile</code>里面添加一行 <code>gem 'jekyll-toc'</code>，然后执行<code>bundle install</code></p>
</li>
<li>
<p>在网站的<code>_config.yml</code>里面添加插件：</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-markdown">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="复制到剪贴板"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-markdown" data-lang="markdown"><span class="line"><span class="cl">plugins:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">- jekyll-toc</span></span></code></pre></div></div>
</li>
<li>
<p>在你的 markdown 文件里面的头部分加上<code>toc: true</code>；</p>
</li>
</ul>
</li>
<li>
<p>使用<a href="https://github.com/allejo/jekyll-toc" target="_blank" rel="noopener noreffer ">jekyll html</a>的解决方案，这是目前在 github pages 下推荐的方案；</p>
<ul>
<li>下载<code>toc.html</code>文件，并放到<code>_includes</code>目录；</li>
<li>在<code>_layouts</code>下用到的<code>html</code>里面，在<code>content</code>前面加上一行<code>% include toc.html html=content %</code>（前后需要加上<code>{ }</code>）</li>
</ul>
</li>
</ol>
]]></description></item></channel></rss>